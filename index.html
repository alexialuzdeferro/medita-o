<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador Ãšnico</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-family: Arial, sans-serif;
        }
        
        /* Contador SUPER discreto */
        #counter {
            position: fixed;
            bottom: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 12px;
            z-index: 9999;
            opacity: 0.6;
            transition: opacity 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(5px);
            user-select: none;
        }
        
        #counter:hover {
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.08);
        }
        
        #count {
            color: #fff;
            font-weight: 500;
            font-size: 12px;
            margin-left: 4px;
        }
        
        /* Indicador de status quase invisÃ­vel */
        .dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(74, 222, 128, 0.4);
            margin-left: 6px;
            vertical-align: middle;
        }
        
        .dot.online {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Apenas o contador na tela -->
    <div id="counter" title="Visitantes totais do site">
        <span style="opacity: 0.7;">ðŸ‘¤</span>
        <span id="count">0</span>
        <span class="dot" id="status-dot"></span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ConfiguraÃ§Ã£o ÃšNICA para todo o site
        const SUPABASE_URL = 'https://qgnprifuachmfxoaalax.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnbnByaWZ1YWNobWZ4b2FhbGF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzODU5MDcsImV4cCI6MjA4MDk2MTkwN30.sKSYFhcI-zflr9RUKXpWF0_5sc6foDG7yxdEirtE0W4';
        
        // Nome ÃšNICO para todo o site
        const SITE_NAME = 'site_alexialuzdeferro';
        
        async function init() {
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Verificar se jÃ¡ contamos nesta sessÃ£o
                if (!sessionStorage.getItem('site_visited')) {
                    // Incrementar contador Ãºnico
                    await incrementUniqueCounter(supabase);
                    sessionStorage.setItem('site_visited', 'true');
                    document.getElementById('status-dot').classList.add('online');
                } else {
                    // Apenas mostrar o valor atual
                    await showCurrentCount(supabase);
                    document.getElementById('status-dot').classList.add('online');
                }
                
            } catch (error) {
                // Modo offline silencioso
                useOfflineCounter();
            }
        }
        
        async function incrementUniqueCounter(supabase) {
            try {
                // MÃ©todo UPSERT (cria ou atualiza)
                const { data: existing } = await supabase
                    .from('page_views')
                    .select('view_count')
                    .eq('page_name', SITE_NAME)
                    .single();
                
                const current = existing?.view_count || 0;
                const newCount = current + 1;
                
                await supabase
                    .from('page_views')
                    .upsert({
                        page_name: SITE_NAME,
                        view_count: newCount,
                        last_updated: new Date().toISOString()
                    }, {
                        onConflict: 'page_name'
                    });
                
                // Animar o nÃºmero
                const countEl = document.getElementById('count');
                countEl.textContent = newCount;
                countEl.style.transform = 'scale(1.3)';
                setTimeout(() => countEl.style.transform = 'scale(1)', 200);
                
                console.log('âœ… Contador atualizado:', newCount);
                
            } catch (error) {
                console.error('Erro:', error);
                throw error;
            }
        }
        
        async function showCurrentCount(supabase) {
            try {
                const { data } = await supabase
                    .from('page_views')
                    .select('view_count')
                    .eq('page_name', SITE_NAME)
                    .single();
                
                if (data) {
                    document.getElementById('count').textContent = data.view_count;
                }
            } catch (error) {
                console.error('Erro ao buscar:', error);
            }
        }
        
        function useOfflineCounter() {
            let local = localStorage.getItem('local_site_views') || 0;
            local = parseInt(local) + 1;
            localStorage.setItem('local_site_views', local);
            
            document.getElementById('count').textContent = local;
            document.getElementById('count').style.opacity = '0.7';
            document.getElementById('status-dot').style.background = 'rgba(251, 191, 36, 0.5)';
        }
        
        // Iniciar
        document.addEventListener('DOMContentLoaded', init);
        
        // Para teste: resetar contador (remova depois)
        window.resetCounter = async function() {
            if (confirm('Resetar contador para 0?')) {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                await supabase
                    .from('page_views')
                    .update({ view_count: 0 })
                    .eq('page_name', SITE_NAME);
                
                sessionStorage.removeItem('site_visited');
                location.reload();
            }
        };
    </script>
</body>
</html>
